<!doctype html>
<html lang="en-us">
  <head>
    <title>BinExploit 0x1 - ROP Chain // Alloysius Goh</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.87.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Alloysius Goh" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://alloygoh.github.io/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="BinExploit 0x1 - ROP Chain"/>
<meta name="twitter:description" content="This post will be the first of many (hopefully) binary exploitation posts.
I am writing this so I can refer in the future and maybe someone will learn something from it too.
I will be using the binary from github.
 Part 1 - Functions &amp; Static Analysis Loading the binary into gdb and looking at the functions reveals 4 interesting functions
 flag vuln win_function1 win_function2  Lets look into the 4 functions and what they do."/>

    <meta property="og:title" content="BinExploit 0x1 - ROP Chain" />
<meta property="og:description" content="This post will be the first of many (hopefully) binary exploitation posts.
I am writing this so I can refer in the future and maybe someone will learn something from it too.
I will be using the binary from github.
 Part 1 - Functions &amp; Static Analysis Loading the binary into gdb and looking at the functions reveals 4 interesting functions
 flag vuln win_function1 win_function2  Lets look into the 4 functions and what they do." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://alloygoh.github.io/posts/binexploit-0x1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-08-09T14:02:53+08:00" />
<meta property="article:modified_time" content="2019-08-09T14:02:53+08:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://alloygoh.github.io"><img class="app-header-avatar" src="/avatar.jpeg" alt="Alloysius Goh" /></a>
      <h1>Alloysius Goh</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>Student | RE | Researcher(?)</p>
      <div class="app-header-social">
        
          <a href="https://github.com/alloygoh" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/alloygoh" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">BinExploit 0x1 - ROP Chain</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Aug 9, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          6 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://alloygoh.github.io/tags/binexploit/">BinExploit</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>This post will be the first of many (hopefully) binary exploitation posts.</p>
<p>I am writing this so I can refer in the future and maybe someone will learn something from it too.</p>
<p>I will be using the binary from <a href="https://github.com/ravernkoh/hacknflag/raw/master/binary/chainzz/participants/chainzz">github</a>.</p>
<hr>
<h1 id="part-1---functions--static-analysis">Part 1 - Functions &amp; Static Analysis</h1>
<p>Loading the binary into <code>gdb</code> and looking at the functions reveals 4 interesting functions</p>
<ul>
<li>flag</li>
<li>vuln</li>
<li>win_function1</li>
<li>win_function2</li>
</ul>
<p><img src="/images/binexp-1/info-func.png" alt="info func"></p>
<p>Lets look into the 4 functions and what they do.</p>
<p><img src="/images/binexp-1/decompile-main.png" alt="decompile main"></p>
<p>Looking at the decompiled code with ghidra shows shows that <strong>main</strong> just initialises the programme &amp; calls the <strong>vuln</strong> function.</p>
<p><img src="/images/binexp-1/decompile-vuln.png" alt="decompile vuln"></p>
<p><strong>vuln</strong> essentially just asks for user input and the programme ends.</p>
<p><img src="/images/binexp-1/decompile-flag.png" alt="decompile flag"></p>
<p>From the decompiled code, we can see that in order to solve this challenge, we have to run flag with win1=true, win2=true &amp; flag argument must be as specified.</p>
<p>This means that we need to chain <strong>win_function1</strong> -&gt; <strong>win_function2</strong> -&gt; <strong>flag</strong> in order to succeed.</p>
<h1 id="part-2---buffer-overflow-in-vuln">Part 2 - Buffer Overflow in vuln</h1>
<p>Loading the binary into gdb and looking at the assembly reveals a <code>gets</code> to receive user input.</p>
<p><img src="/images/binexp-1/disas-vuln.png" alt="disas vuln"></p>
<p>The problem with gets is that it does not check the length of user input, thus resulting in potential buffer overflow and redirection of code flow.</p>
<p>We can modify the EIP by finding the point of overflow and change it to any address we want.</p>
<p>For this case, we want it to go to the <strong>win_function1</strong> first.</p>
<p>We can do that by sending a padding till the point of overflow, then follow up by 0x080485e6 to redirect the code execution to <strong>win_function1</strong>.</p>
<p>By sending in 32 character, we can see that we overflowed the return address on the stack which is then used by the EIP.</p>
<p><img src="/images/binexp-1/buffer1.png" alt="buffer1"></p>
<p>As per the picture, we can see that we can control the EIP with the last 4 bytes of our 32 character input.</p>
<p>With that, we can redirect the code flow to the <strong>win_function1</strong></p>
<p><img src="/images/binexp-1/eip-win1.png" alt="eip-win1"></p>
<p>As we can see now, the programme crashes as the return address is not set yet.</p>
<p>So how can we set the return address?</p>
<p>In order to do that, we must first understand how functions are called in assembly.</p>
<p>Before a function is called, the parameters for the function are pushed onto the stack. The function is then called.</p>
<p>When the call instruction is executed, the address of the (EIP + 1) is pushed onto the stack as a return address.</p>
<pre><code>argument N &lt;-- EBP
...
...
argument 1
argument 2
return address &lt;-- ESP
</code></pre><p>After that, EBP is pushed and EBP is set to the ESP and the ESP moves downwards to create space for local variables within the function.</p>
<pre><code>argument N
...
...
argument 1
argument 2
return address 
previous ebp address &lt;-- EBP
local var space 
local var space
local var space
local var space &lt;-- ESP
</code></pre><p>When the function ends or when it exits, the ESP is shifted back up by how many address space it allocated, effectively destroying the local variable space.
The EBP is then then restored with a pop instruction.</p>
<pre><code>argument N
...
...
argument 1
argument 2
return address 
previous ebp address &lt;-- ESP &lt;-- EBP
destroyed
destroyed
destroyed
destroyed
</code></pre><pre><code>argument N &lt;-- EBP
...
...
argument 1
argument 2 &lt;-- ESP
destroyed
destroyed
destroyed
destroyed
destroyed
</code></pre><p>From the visualization above, we see that we can by padding the local var space, we can eventually overwrite the return address for vuln, achieving code redirection.</p>
<p>We can then overwrite the return address to redirect the code flow to <strong>win_function1</strong></p>
<h1 id="part-3---chaining-redirection-to-win_function2">Part 3 - Chaining Redirection to win_function2</h1>
<p>Now that we know how a function call works, let&rsquo;s figure out why the programme crashes when it exits <strong>win_function1</strong></p>
<p>Let&rsquo;s set a breakpoint right before the EBP is pop-ed and take a look at the stack.</p>
<p><img src="/images/binexp-1/bp-win1.png" alt="bp-win1"></p>
<p>From the picture, we can see that when EBP is pop-ed, EBP will be set to 0x41414141 and the ESP will move up.</p>
<p><img src="/images/binexp-1/bp2-win1.png" alt="bp2-win1"></p>
<p>From the picture, we can see that when <strong>win_function1</strong> reaches the ret instruction, 0x00000000 is at the top of the stack. This means that EIP will restore that address to continue the programme flow. 0x000000 is not a valid location for instructions and the programme crashes.</p>
<p>We now need to add on to our payload to see if we can overflow this return address to go to <strong>win_function2</strong>.</p>
<p>We can simply pad the end with &ldquo;B&rdquo; to see how much we need to pad in order to reach this return address.</p>
<p><img src="/images/binexp-1/return-win1.png" alt="return-win1"></p>
<p>We see that by adding on to our payload, we have already overwritten the return address. We can now change the &ldquo;B&rdquo; to 0x80485fd, the adress of <strong>win_function2</strong>.</p>
<h1 id="part-4---setting-arguments-for-win_function2-and-chaining-to-flag-function">Part 4 - Setting Arguments for win_function2 and Chaining to flag function</h1>
<p>Let&rsquo;s take a look at what <strong>win_function2</strong> does before we move on.</p>
<p><img src="/images/binexp-1/disas-win2.png" alt="disas-win2"></p>
<p>Looking at the disassembly of <strong>win_function2</strong>, we can see that there is a</p>
<pre><code class="language-assembly" data-lang="assembly">cmp DWORD PTR [ebp+0x8],0xbaaccaad
</code></pre><p>We can see that <strong>win_function2</strong> requires the argument to match 0xbaaccaad. We can deduce that as function arguments are normally referenced as [ebp+0xN] in assembly.</p>
<p>We can set a breakpoint right before the compare to see where the argument is stored.</p>
<p><img src="/images/binexp-1/bp-win2.png" alt="bp-win2"></p>
<p>Currently, the argument passed is 0xffffca1c. Since our &ldquo;A&rdquo; padding is only 8 bytes away from the argument, we can overflow it to set it to 0xbaaccaad.</p>
<p><img src="/images/binexp-1/bp2-win2.png" alt="bp2-win2"></p>
<p>We have successfully overwritten the argument and we can continue to chain to the flag function.</p>
<p>By setting a breakpoint before the return instruction, we can see where the return address is stored and attempt to overwrite it.</p>
<p><img src="/images/binexp-1/bp3-win2.png" alt="bp3-win2"></p>
<p>At the top of the stack is our padding of &ldquo;C&rdquo; before we set the argument for <strong>win_function2</strong>. By changing the &ldquo;C&rdquo; to the address of flag, we can redirect the code execution there.</p>
<h1 id="part-5---setting-arguments-for-flag-function--getting-flag">Part 5 - Setting Arguments for flag function &amp; Getting Flag</h1>
<p><img src="/images/binexp-1/disas-flag.png" alt="disas-flag"></p>
<p>Looking at the disassembly of the flag function, we can see that we need to set the function argument to 0xdeadbeef.</p>
<p>Let&rsquo;s set a breakpoint before the compare and see where the argument is in the stack.</p>
<p><img src="/images/binexp-1/bp-flag.png" alt="bp-flag"></p>
<p>We can see that the current argument is 0x00000000. We can set it by continuing to pad the payload and overwrite the argument.</p>
<p><img src="/images/binexp-1/bp2-flag.png" alt="bp2-flag"></p>
<p>We have now overwritten the argument. Let&rsquo;s see what happens now.</p>
<p><img src="/images/binexp-1/solved.png" alt="solved"></p>
<p>The Challenge has been solved!!</p>
<hr>
<p>I hope that this article has made the understanding of the ROP Chaining attack easier as it was really a struggle for me to understand this and I hope that you have benefited from my suffering :)</p>
<p>Again, if anything was wrong in this article, please contact me so I can change and learn from it. (^o^)</p>
<p>See you in the next BinExploit!</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
